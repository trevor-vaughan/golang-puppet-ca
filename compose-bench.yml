# Load / performance test topology for puppet-ca.
#
# Services
# --------
#   puppet-ca  — CA server with autosign=true so the workflow scenario
#                (generate → status → cert → clean) is fully self-contained.
#   k6         — Grafana k6 load runner executing test/load.js.
#
# Usage (from project root):
#   mage bench                        # build images, run k6, tear down
#   podman-compose -f compose-bench.yml up --build   # interactive

name: puppet-ca-bench

services:

  # ── CA server ─────────────────────────────────────────────────────────────
  puppet-ca:
    build:
      context: .
      dockerfile: Dockerfile.run
    image: puppet-ca-integ:latest   # reuse the image built by mage build / integCompose
    command:
      - --cadir=/data
      - --autosign-config=true      # workflow scenario needs immediate signing
      - --no-tls-required           # test-only stack; CA not reachable from outside compose network
      - -v=0                        # quiet logging; reduces I/O noise during load
    expose:
      - "8140"
    volumes:
      - ca-data:/data
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8140/healthz/ready"]
      interval: 3s
      timeout: 5s
      retries: 20
      start_period: 8s

  # ── k6 load runner ────────────────────────────────────────────────────────
  k6:
    image: grafana/k6:latest
    tty: true       # allocate a PTY so k6 uses its live updating progress display
    command:
      - run
      - --env
      - CA_URL=http://puppet-ca:8140
      - /test/load.js
    environment:
      # Passed in by `mage test:bench` via systemInfo(); used in the final report.
      - REPORT_HOST
      - REPORT_CPUS
      - REPORT_MEM_GB
      - REPORT_KERNEL
    volumes:
      # Mount the test directory read-only; :z relabels for SELinux (RHEL/CentOS).
      - ./test:/test:ro,z
    depends_on:
      puppet-ca:
        condition: service_healthy

volumes:
  ca-data:
